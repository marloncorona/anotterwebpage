@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager

@{
    ViewData["Title"] = "Agenda";
    Layout = "_Layout";
}

@if (!SignInManager.IsSignedIn(User))
{
  <div style="margin-top:3rem; display:flex; flex-direction:column; align-items:center; text-align:center;">
    <h2 style="font-weight:600; margin-bottom:1rem;">Inicia sesión para agendar</h2>

    <p style="max-width:400px; color:#555; margin-bottom:2rem;">
      Necesitas una cuenta para acceder al calendario y agendar una consulta.
    </p>

    <div style="display:flex; gap:1rem;">
      <a class="btn-contact" asp-area="Identity" asp-page="/Account/Login">Iniciar sesión</a>

      <a class="btn-contact" asp-area="Identity" asp-page="/Account/Register">Crear cuenta</a>
    </div>
    <img src="~/images/ottieSneaking.png" style="width:60%;height: auto; margin-top:1.5rem; justify-content: center;" />
  </div>

  return;
} 

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<img class="login-bg" src="~/images/accountBg.png" alt="Fondo" />

<h2 class="mb-3 mainTitle">Agenda tu cita</h2>
<div class="calendar-wrap">
  <div id="calendar"></div>
  <img src="images/ottieagenda.PNG"/>
</div>



<!-- Modal -->
<div id="bookModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35);
     align-items:center; justify-content:center; z-index:1200;">
  <form id="bookForm" style="background:#fff; padding:20px; border-radius:16px; width:40%;display:flex; flex-direction: column; ">
    <h3 style="margin-top:0;">Confirmar cita</h3>
    <p id="slotText" style="margin:.5rem 0;"></p>
    <input type="nombre" name="nombre" placeholder="Nombre" required class="form-control" />
    <input type="apellido" name="apellido" placeholder="Apellido" required class="form-control" style="margin-top:.5rem;" />
    <input type="nombrePaciente" name="nombrePaciente" placeholder="Nombre del paciente" optional class="form-control" style="margin-top:.5rem;" />
    <small style="display:block; margin-top:.25rem; color:#6c757d;font-size: x-small;">*Opcional</small>
    <input type="email" name="email" placeholder="Email" required class="form-control" style="margin-top:.5rem;" />
    <input type="numero" name="numero" placeholder="Whatsapp" required class="form-control" style="margin-top:.5rem;" />


    <textarea name="motivo" placeholder="Motivo de consulta" class="form-control" style="margin-top:.5rem;"></textarea>
    
    <div style="margin-top: 1rem;display: flex;flex-direction: row;gap: .75rem;">
      <label style=" font-weight:600 ;margin-bottom:.3rem;">Modalidad</label>

      <label style="display: flex;align-items: center; gap: .6rem;font-size: 1rem;cursor: pointer;user-select: none;">
        <input type="radio" name="modalidad" value="Presencial" required>
        <span style="font-weight: 500;">Presencial</span>
      </label>

      <label style="display: flex;align-items: center; gap: .6rem;font-size: 1rem;cursor: pointer;user-select: none;">
        <input type="radio" name="modalidad" value="Online">
        <span style="font-weight: 500;">En línea</span>
      </label>
    </div>
    
    <div style="margin-top:1rem; display:flex; gap:.5rem; justify-content:flex-end;">
      <button type="button" id="cancelBtn" class="btn navlink">Cancelar</button>
      <button type="submit" class="btn-contact">Reservar</button>
    </div>
  </form>
</div>

<div id="viewAppointmentModal" class="modal">
  <div class="modal-content">
    <h3>Tu cita</h3>

    <input id="viewNombre" readonly class="form-control"/>
    <input id="viewApellido" readonly class="form-control"/>
    <input id="viewEmail" readonly class="form-control"/>
    <input id="viewNumero" readonly class="form-control"/>
    <textarea id="viewMotivo" readonly class="form-control"></textarea>
    <input id="viewModalidad" readonly class="form-control"/>

    <button onclick="document.getElementById('viewAppointmentModal').style.display='none'" class="btn btn-secondary">
      Cerrar
    </button>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
  const tz = 'America/Tijuana';
  const calendarEl = document.getElementById('calendar');
  const modal = document.getElementById('bookModal');
  const slotText = document.getElementById('slotText');
  const form = document.getElementById('bookForm');

  const viewModal = document.getElementById("viewAppointmentModal");
  const closeViewModal = document.getElementById("closeViewModal");

  let selStart = null, selEnd = null;

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    timeZone: tz,
    locale: 'es',
    slotDuration: '01:00:00',
    slotLabelInterval: '01:00',
    slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
    slotMinTime: '07:00:00',
    slotMaxTime: '20:00:00',
    scrollTime: '07:00:00',
    snapDuration: '01:00:00',
    allDaySlot: false,
    firstDay: 0,
    expandRows: true,
    height: 'auto',
    selectable: true,
    selectMirror: true,
    selectOverlap: false,
    nowIndicator: true,

    businessHours: [
      { daysOfWeek: [1,2,3,4,5], startTime: '09:00', endTime: '18:00' },
      { daysOfWeek: [6],         startTime: '09:00', endTime: '13:00' }
    ],

    events: {
      url: '@Url.Action("GetBusy", "Calendar")',
      method: 'GET',
      failure: () => alert('No se pudo cargar disponibilidad')
    },

    eventDidMount: function(info) {
      // Hacer que todas las citas sean "clickeables"
      info.el.style.cursor = "pointer";

      if (info.event.extendedProps.isMine) {
        // Mis citas
        info.el.style.color = "#000";                
      } else {
        // Citas de otros usuarios
        info.el.style.backgroundColor = "#A8C5FF";   
        info.el.style.borderColor = "#7AA4F5";
        info.el.style.color = "#000";             
      }
    },

    // permitir que solo el usuario abra sus propias citas
    eventClick: function(info) {

      if (!info.event.extendedProps.isMine) return;

      const id = info.event.id; 

      fetch(`/Calendar/GetAppointment/${id}`)
        .then(res => res.json())
        .then(data => {

          document.getElementById("viewNombre").value = data.nombre;
          document.getElementById("viewApellido").value = data.apellido;
          document.getElementById("viewEmail").value = data.email;
          document.getElementById("viewNumero").value = data.numero;
          document.getElementById("viewMotivo").value = data.motivo;
          document.getElementById("viewModalidad").value = data.modalidad;

          document.getElementById("viewAppointmentModal").style.display = "flex";
        });
    },

    selectAllow: function(info) {
      return info.start >= new Date();
    },

    select: function(info) {
      const start = new Date(info.start);
      const end = new Date(start.getTime() + 60 * 60 * 1000);

      selStart = start.toISOString();
      selEnd = end.toISOString();

      slotText.textContent = `${calendar.formatDate(start, { 
        weekday:'long', day:'2-digit', month:'long', year:'numeric', hour:'numeric', minute:'2-digit'
      })} – ${calendar.formatDate(end, { hour:'numeric', minute:'2-digit' })}`;

      modal.style.display = 'flex';
    }
  });

  calendar.render();

  setTimeout(() => calendar.updateSize(), 150);
  window.addEventListener('resize', () => calendar.updateSize());

  // crear cita
  form.onsubmit = async (e) => {
    e.preventDefault();

    const payload = {
      start: selStart,
      end: selEnd,
      nombre: form.nombre.value,
      apellido: form.apellido.value,
      nombrePaciente: form.nombrePaciente?.value,
      email: form.email.value,
      numero: form.numero.value,
      modalidad: form.modalidad?.value,
      motivo: form.motivo.value,
    };

    const res = await fetch('@Url.Action("Book", "Calendar")', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      modal.style.display = 'none';
      form.reset();
      calendar.refetchEvents();
      alert('¡Cita reservada!');
    } else {
      alert("No se pudo reservar:\n" + await res.text());
    }
  };

  document.getElementById('cancelBtn').onclick = () => {
    modal.style.display = 'none';
    calendar.unselect();
  };

  closeViewModal.onclick = () => {
    viewModal.style.display = "none";
  };

});
</script>


<style>
#calendar { background:#fff; border-radius:16px; box-shadow:0 8px 20px rgba(0,0,0,.06); padding:1rem; }
.calendar-wrap { display:flex; flex-direction:row; }
.calendar-wrap img { display:flex; width:20rem; height:20rem; }
.btn { padding:.5rem 1rem; border-radius:20px; }
.form-control { padding:.5rem; border:1px solid #ddd; border-radius:8px; }
.fc .fc-timegrid-slot { height: 3rem; }
.fc-timegrid-slot:hover,
.fc-timegrid-axis:hover,
.fc-timegrid-col:hover,
.fc-daygrid-day:hover {
  cursor: pointer !important;
}
</style>
